from datetime import datetime
from database import DatabaseConnection

class DataProcessor:
    def __init__(self, data_source: str):
        # Initialize database connection using DatabaseConnection class
        self.db_connection = DatabaseConnection(data_source)

    def log_to_database(self, username: str, function_name: str, parameters: dict, data_type: str) -> None:
        """
        Log function call details to the database.

        :param username: The username of the person calling the function.
        :param function_name: The name of the function being called.
        :param parameters: A dictionary of parameters used in the function call.
        :param data_type: The type of data being processed (used for data_name).
        """
        timestamp = datetime.now()
        data_group = parameters.get('data_group')
        data_source = parameters.get('data_source')
        data_name = data_type
        data_description = f"data_group: {data_group}, data_source: {data_source}, " \
                           f"bank_code: {parameters.get('bank_code')}, " \
                           f"start_period: {parameters.get('start_period')}, end_period: {parameters.get('end_period')}"

        log_data = {
            "timestamp": timestamp,
            "username": username,
            "data_group": data_group,
            "data_source": data_source,
            "data_name": data_name,
            "data_description": data_description,
            "access_method": "data gate"  # default value is 'data gate'
        }

        # Insert the log into the database using the provided database connection
        insert_query = """
        INSERT INTO bsis_data_usage (timestamp, username, data_group, data_source, data_name, data_description, access_method)
        VALUES (:timestamp, :username, :data_group, :data_source, :data_name, :data_description, :access_method)
        """
        
        with self.db_connection.cursor() as cursor:
            cursor.execute(insert_query, log_data)
            self.db_connection.conn.commit()

    def read_itrs_data(self, data_group: str, data_source: str, data_type: str, bank_code: str, start_period: str, end_period: str, username: str):
        """
        Read ITRS data based on provided parameters and log the operation.
        
        :param data_group: The data group to process.
        :param data_source: The source of the data.
        :param data_type: The type of the data.
        :param bank_code: The bank code for the operation.
        :param start_period: The start period of the data.
        :param end_period: The end period of the data.
        :param username: The username of the person making the call.
        """
        # Log the function call
        parameters = {
            "data_group": data_group,
            "data_source": data_source,
            "data_type": data_type,
            "bank_code": bank_code,
            "start_period": start_period,
            "end_period": end_period
        }
        self.log_to_database(username=username, function_name="read_itrs_data", parameters=parameters, data_type=data_type)

        # Perform the function's primary task (replace this with actual functionality)
        print(f"Processing ITRS data for {data_group}, {data_source}, {data_type}, {bank_code}, {start_period}, {end_period}")
        # Your logic for processing data goes here...


"""
CREATE TABLE bsis_data_usage (
    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY, -- Auto-incrementing ID for each entry
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,                 -- Timestamp of the log entry
    username VARCHAR2(100) NOT NULL,                               -- Username of the user making the request
    data_group VARCHAR2(100),                                      -- Group of data being accessed
    data_source VARCHAR2(100),                                     -- Source of the data
    data_name VARCHAR2(100),                                       -- Specific name or identifier of the data
    data_description CLOB NOT NULL,                                -- Detailed description of the data or parameters
    access_method VARCHAR2(50) DEFAULT 'data gate' NOT NULL        -- Access method, defaulting to "data gate"
);

"""